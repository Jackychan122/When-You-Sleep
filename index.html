<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4a49b0',
                        'primary-light': '#7b7ae7',
                        'sleep-poor': '#e67c73',
                        'sleep-fair': '#f7cb4d',
                        'sleep-good': '#80c883',
                        'sleep-excellent': '#4285f4',
                    }
                }
            }
        }
    </script>
    <style>
        .contribution-cell {
            width: 14px;
            height: 14px;
            margin: 2px;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .contribution-cell:hover {
            transform: scale(1.2);
        }

        .sleep-entry-item {
            transition: all 0.3s ease;
        }
        
        .sleep-entry-item:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 150px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .dark .tooltip .tooltip-text {
            background-color: rgba(255, 255, 255, 0.8);
            color: #000;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">
    <div class="min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar Navigation -->
        <aside class="w-full md:w-64 bg-gray-100 dark:bg-gray-800 md:min-h-screen p-4">
            <div class="flex items-center justify-between md:justify-start mb-8">
                <h1 class="text-2xl font-bold text-primary dark:text-primary-light flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                    Sleep Tracker
                </h1>
                <button id="mobile-menu-toggle" class="md:hidden text-gray-600 dark:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
            
            <nav id="nav-menu" class="hidden md:block">
                <ul class="space-y-2">
                    <li>
                        <button data-section="dashboard" class="nav-link w-full flex items-center p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors bg-gray-200 dark:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary dark:text-primary-light" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                            </svg>
                            Dashboard
                        </button>
                    </li>
                    <li>
                        <button data-section="analytics" class="nav-link w-full flex items-center p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary dark:text-primary-light" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            Analytics
                        </button>
                    </li>
                    <li>
                        <button data-section="log" class="nav-link w-full flex items-center p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary dark:text-primary-light" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            Log Sleep
                        </button>
                    </li>
                    <li>
                        <button data-section="data" class="nav-link w-full flex items-center p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary dark:text-primary-light" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7c0-2-1-3-3-3H7c-2 0-3 1-3 3z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17v-10" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17v-4" />
                            </svg>
                            Data Management
                        </button>
                    </li>
                </ul>

                <div class="mt-8 pt-4 border-t border-gray-300 dark:border-gray-600">
                    <button id="theme-toggle" class="w-full flex items-center p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" id="dark-icon" class="h-5 w-5 mr-2 text-primary dark:text-primary-light hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" id="light-icon" class="h-5 w-5 mr-2 text-primary dark:text-primary-light dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <span id="theme-text">Dark Mode</span>
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-6 overflow-auto">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="animate-fade-in">
                <header class="mb-6">
                    <h2 class="text-2xl font-bold">Sleep Dashboard</h2>
                    <p class="text-gray-600 dark:text-gray-400">Track your sleep patterns and consistency</p>
                </header>

                <div class="grid gap-6 mb-8 md:grid-cols-2 xl:grid-cols-4">
                    <!-- Sleep Score Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900 mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 dark:text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Sleep Score</p>
                                <h4 id="sleep-score" class="text-2xl font-semibold">85</h4>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div id="sleep-score-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 85%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Average Sleep Duration Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 dark:bg-purple-900 mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500 dark:text-purple-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Avg. Duration</p>
                                <h4 id="avg-duration" class="text-2xl font-semibold">7.5h</h4>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                            <span id="duration-trend" class="text-green-500">↑ 0.5h</span> from last week
                        </p>
                    </div>

                    <!-- Bedtime Consistency Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 dark:bg-green-900 mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 dark:text-green-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Consistency</p>
                                <h4 id="consistency-score" class="text-2xl font-semibold">Good</h4>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Bedtime varies by <span id="bedtime-variance">±23 min</span></p>
                    </div>

                    <!-- Sleep Quality Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 dark:bg-yellow-900 mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500 dark:text-yellow-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Quality Rating</p>
                                <h4 id="quality-score" class="text-2xl font-semibold">3.8 / 5</h4>
                            </div>
                        </div>
                        <div class="flex mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300 dark:text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Sleep Contribution Grid -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700 mb-8">
                    <h3 class="text-lg font-semibold mb-4">Sleep Contributions</h3>
                    <div class="mb-3 text-sm text-gray-600 dark:text-gray-400 flex flex-wrap gap-4">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-gray-200 dark:bg-gray-700 rounded mr-2"></div>
                            <span>No data</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-sleep-poor rounded mr-2"></div>
                            <span>&lt; 6h (Poor)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-sleep-fair rounded mr-2"></div>
                            <span>6-7h (Fair)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-sleep-good rounded mr-2"></div>
                            <span>7-8h (Good)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-sleep-excellent rounded mr-2"></div>
                            <span>&gt; 8h (Excellent)</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <div id="contribution-grid" class="flex flex-col min-w-max"></div>
                    </div>
                </div>

                <!-- Sleep Trend Chart -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Recent Sleep Trends</h3>
                    <div class="relative h-72">
                        <canvas id="sleep-trend-chart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics-section" class="hidden animate-fade-in">
                <header class="mb-6">
                    <h2 class="text-2xl font-bold">Sleep Analytics</h2>
                    <p class="text-gray-600 dark:text-gray-400">Detailed insights about your sleep patterns</p>
                </header>

                <div class="grid gap-6 mb-8 lg:grid-cols-2">
                    <!-- Sleep Duration Distribution -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">Sleep Duration Distribution</h3>
                        <div class="relative h-72">
                            <canvas id="duration-distribution-chart"></canvas>
                        </div>
                    </div>

                    <!-- Sleep Quality vs Duration -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">Sleep Quality vs Duration</h3>
                        <div class="relative h-72">
                            <canvas id="quality-duration-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid gap-6 mb-8 lg:grid-cols-2">
                    <!-- Bedtime Consistency -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">Bedtime Consistency</h3>
                        <div class="relative h-72">
                            <canvas id="bedtime-consistency-chart"></canvas>
                        </div>
                    </div>

                    <!-- Sleep Quality Trend -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">Sleep Quality Trend</h3>
                        <div class="relative h-72">
                            <canvas id="quality-trend-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sleep Insights -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Sleep Insights</h3>
                    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-medium mb-2 text-primary dark:text-primary-light">Optimal Sleep Duration</h4>
                            <p class="text-gray-700 dark:text-gray-300">Your best sleep quality occurs when you sleep for 7.5-8 hours.</p>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-medium mb-2 text-primary dark:text-primary-light">Consistency Impact</h4>
                            <p class="text-gray-700 dark:text-gray-300">You report better sleep quality when your bedtime varies less than 30 minutes.</p>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-medium mb-2 text-primary dark:text-primary-light">Weekend Pattern</h4>
                            <p class="text-gray-700 dark:text-gray-300">Your weekend sleep tends to be longer but often lower quality than weekday sleep.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Log Sleep Section -->
            <section id="log-section" class="hidden animate-fade-in">
                <header class="mb-6">
                    <h2 class="text-2xl font-bold">Log Sleep</h2>
                    <p class="text-gray-600 dark:text-gray-400">Record your sleep data</p>
                </header>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                    <form id="sleep-form" class="space-y-6">
                        <div class="grid gap-6 md:grid-cols-2">
                            <div>
                                <label for="sleep-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date</label>
                                <input type="date" id="sleep-date" name="sleep-date" required 
                                    class="w-full px-4 py-2 text-base border rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-primary-light focus:border-primary dark:focus:border-primary-light bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600">
                            </div>
                            <div>
                                <label for="sleep-quality" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sleep Quality</label>
                                <div class="flex space-x-2 mt-2">
                                    <input type="hidden" id="sleep-quality" name="sleep-quality" value="3">
                                    <button type="button" data-rating="1" class="sleep-rating-btn w-8 h-8 rounded-full flex items-center justify-center bg-gray-200 dark:bg-gray-700 hover:bg-primary hover:text-white transition-colors">1</button>
                                    <button type="button" data-rating="2" class="sleep-rating-btn w-8 h-8 rounded-full flex items-center justify-center bg-gray-200 dark:bg-gray-700 hover:bg-primary hover:text-white transition-colors">2</button>
                                    <button type="button" data-rating="3" class="sleep-rating-btn w-8 h-8 rounded-full flex items-center justify-center bg-primary text-white dark:bg-primary-light">3</button>
                                    <button type="button" data-rating="4" class="sleep-rating-btn w-8 h-8 rounded-full flex items-center justify-center bg-gray-200 dark:bg-gray-700 hover:bg-primary hover:text-white transition-colors">4</button>
                                    <button type="button" data-rating="5" class="sleep-rating-btn w-8 h-8 rounded-full flex items-center justify-center bg-gray-200 dark:bg-gray-700 hover:bg-primary hover:text-white transition-colors">5</button>
                                </div>
                            </div>
                        </div>

                        <div class="grid gap-6 md:grid-cols-2">
                            <div>
                                <label for="bedtime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bedtime</label>
                                <input type="time" id="bedtime" name="bedtime" required
                                    class="w-full px-4 py-2 text-base border rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-primary-light focus:border-primary dark:focus:border-primary-light bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600">
                            </div>
                            <div>
                                <label for="wake-time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Wake Time</label>
                                <input type="time" id="wake-time" name="wake-time" required
                                    class="w-full px-4 py-2 text-base border rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-primary-light focus:border-primary dark:focus:border-primary-light bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600">
                            </div>
                        </div>

                        <div>
                            <label for="sleep-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                            <textarea id="sleep-notes" name="sleep-notes" rows="3" placeholder="Any factors that affected your sleep..."
                                class="w-full px-4 py-2 text-base border rounded-lg focus:ring-2 focus:ring-primary dark:focus:ring-primary-light focus:border-primary dark:focus:border-primary-light bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600"></textarea>
                        </div>

                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="screen-time" name="screen-time" class="rounded text-primary focus:ring-primary dark:focus:ring-primary-light border-gray-300 dark:border-gray-600">
                                <label for="screen-time" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Used screens before bed</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="caffeine" name="caffeine" class="rounded text-primary focus:ring-primary dark:focus:ring-primary-light border-gray-300 dark:border-gray-600">
                                <label for="caffeine" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Had caffeine after 2pm</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="exercise" name="exercise" class="rounded text-primary focus:ring-primary dark:focus:ring-primary-light border-gray-300 dark:border-gray-600">
                                <label for="exercise" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Exercised today</label>
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark dark:bg-primary-light dark:hover:bg-primary dark:text-gray-900 transition-colors">
                                Save Sleep Log
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Recent Sleep Logs -->
                <div class="mt-8 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Recent Sleep Logs</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Duration</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Bedtime</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Wake Time</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Quality</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sleep-log-table" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Sleep logs will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Data Management Section -->
            <section id="data-section" class="hidden animate-fade-in">
                <header class="mb-6">
                    <h2 class="text-2xl font-bold">Data Management</h2>
                    <p class="text-gray-600 dark:text-gray-400">Export, import, and manage your sleep data</p>
                </header>

                <div class="grid gap-6 md:grid-cols-2">
                    <!-- Export Data -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-2">Export Data</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Download your sleep data as a JSON file</p>
                        <button id="export-data" class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark dark:bg-primary-light dark:hover:bg-primary dark:text-gray-900 transition-colors flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export Sleep Data
                        </button>
                        <div id="export-area" class="mt-4 hidden">
                            <p class="mb-2 text-sm text-gray-600 dark:text-gray-400">Copy the data below and save it to a file:</p>
                            <textarea id="export-json" class="w-full h-32 p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600" readonly></textarea>
                            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Note: To save this data, copy the text above and paste it into a text file on your device.</p>
                        </div>
                    </div>

                    <!-- Import Data -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-2">Import Data</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Restore previously exported sleep data</p>
                        <div class="mb-4">
                            <textarea id="import-json" class="w-full h-32 p-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Paste your JSON data here..."></textarea>
                        </div>
                        <button id="import-data" class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark dark:bg-primary-light dark:hover:bg-primary dark:text-gray-900 transition-colors flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Import Sleep Data
                        </button>
                        <div id="import-status" class="mt-2 text-sm hidden"></div>
                    </div>
                </div>

                <!-- Data Management Options -->
                <div class="mt-8 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Data Management Options</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center pb-4 border-b border-gray-200 dark:border-gray-700">
                            <div>
                                <h4 class="font-medium">Clear All Data</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Remove all sleep entries and reset the app</p>
                            </div>
                            <button id="clear-data" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-600 transition-colors">
                                Clear Data
                            </button>
                        </div>
                        <div class="flex justify-between items-center pb-4 border-b border-gray-200 dark:border-gray-700">
                            <div>
                                <h4 class="font-medium">Add Demo Data</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Populate the app with sample sleep data</p>
                            </div>
                            <button id="demo-data" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
                                Load Demo Data
                            </button>
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-medium">Data Storage</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Current storage usage for sleep data</p>
                            </div>
                            <div class="text-right">
                                <span id="data-usage" class="text-sm font-medium">0 KB</span>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Browser storage</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Confirmation Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mx-4 max-w-md w-full">
            <h2 id="modal-title" class="text-xl font-bold mb-4"></h2>
            <p id="modal-message" class="mb-6 text-gray-600 dark:text-gray-400"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button id="modal-confirm" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark dark:bg-primary-light dark:hover:bg-primary dark:text-gray-900 transition-colors">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize dark mode based on user preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-text').textContent = 'Light Mode';
        } else {
            document.getElementById('theme-text').textContent = 'Dark Mode';
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-text').textContent = 'Light Mode';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-text').textContent = 'Dark Mode';
            }
        });

        // Class for handling sleep data
        class SleepTracker {
            constructor() {
                this.sleepData = [];
                this.loadData();
                this.setupEventListeners();
                this.setupUI();
            }

            // Load data from session storage
            loadData() {
                try {
                    const storedData = sessionStorage.getItem('sleepData');
                    if (storedData) {
                        this.sleepData = JSON.parse(storedData);
                    } else {
                        // Load demo data if no data exists
                        this.loadDemoData();
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.sleepData = [];
                }
            }

            // Save data to session storage
            saveData() {
                try {
                    sessionStorage.setItem('sleepData', JSON.stringify(this.sleepData));
                    this.updateDataUsage();
                } catch (error) {
                    console.error('Error saving data:', error);
                    // Handle storage errors
                    this.showToast('Error saving data. Your browser might have limited storage.', 'error');
                }
            }

            // Add a new sleep entry
            addSleepEntry(entry) {
                // Check if entry already exists for this date
                const existingIndex = this.sleepData.findIndex(item => item.date === entry.date);
                
                if (existingIndex >= 0) {
                    // Update existing entry
                    this.sleepData[existingIndex] = entry;
                } else {
                    // Add new entry
                    this.sleepData.push(entry);
                }
                
                // Sort data by date (newest first)
                this.sleepData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                this.saveData();
                this.updateUI();
            }

            // Delete a sleep entry
            deleteSleepEntry(date) {
                this.sleepData = this.sleepData.filter(item => item.date !== date);
                this.saveData();
                this.updateUI();
            }

            // Update all UI elements
            updateUI() {
                this.updateSleepLogs();
                this.updateContributionGrid();
                this.updateSleepTrendChart();
                this.updateAnalyticsCharts();
                this.updateSummaryStats();
            }

            // Set up event listeners
            setupEventListeners() {
                // Mobile menu toggle
                document.getElementById('mobile-menu-toggle').addEventListener('click', () => {
                    const navMenu = document.getElementById('nav-menu');
                    navMenu.classList.toggle('hidden');
                });

                // Navigation
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        // Hide all sections
                        document.querySelectorAll('main > section').forEach(section => {
                            section.classList.add('hidden');
                        });
                        
                        // Show selected section
                        const sectionId = link.getAttribute('data-section');
                        document.getElementById(`${sectionId}-section`).classList.remove('hidden');
                        
                        // Update active nav link
                        navLinks.forEach(navLink => {
                            navLink.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                        });
                        link.classList.add('bg-gray-200', 'dark:bg-gray-700');
                        
                        // Hide mobile menu after selection on small screens
                        if (window.innerWidth < 768) {
                            document.getElementById('nav-menu').classList.add('hidden');
                        }
                    });
                });

                // Theme toggle
                document.getElementById('theme-toggle').addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    const isDark = document.documentElement.classList.contains('dark');
                    document.getElementById('theme-text').textContent = isDark ? 'Light Mode' : 'Dark Mode';
                });

                // Sleep form submission
                document.getElementById('sleep-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSleepFormSubmit();
                });

                // Sleep rating buttons
                document.querySelectorAll('.sleep-rating-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Reset all buttons
                        document.querySelectorAll('.sleep-rating-btn').forEach(b => {
                            b.classList.remove('bg-primary', 'text-white', 'dark:bg-primary-light');
                            b.classList.add('bg-gray-200', 'dark:bg-gray-700');
                        });
                        
                        // Set selected button
                        btn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                        btn.classList.add('bg-primary', 'text-white', 'dark:bg-primary-light');
                        
                        // Update hidden input
                        document.getElementById('sleep-quality').value = btn.getAttribute('data-rating');
                    });
                });

                // Data management
                document.getElementById('export-data').addEventListener('click', () => {
                    this.exportData();
                });

                document.getElementById('import-data').addEventListener('click', () => {
                    this.importData();
                });

                document.getElementById('clear-data').addEventListener('click', () => {
                    this.showConfirmModal(
                        'Clear All Data', 
                        'Are you sure you want to delete all sleep data? This action cannot be undone.',
                        () => {
                            this.sleepData = [];
                            this.saveData();
                            this.updateUI();
                            this.showToast('All data has been cleared', 'success');
                        }
                    );
                });

                document.getElementById('demo-data').addEventListener('click', () => {
                    this.showConfirmModal(
                        'Load Demo Data', 
                        'This will replace your current data with demo data. Continue?',
                        () => {
                            this.loadDemoData();
                            this.saveData();
                            this.updateUI();
                            this.showToast('Demo data loaded successfully', 'success');
                        }
                    );
                });

                // Modal handlers
                document.getElementById('modal-cancel').addEventListener('click', () => {
                    document.getElementById('modal').classList.add('hidden');
                });
            }

            // Setup UI initial state
            setupUI() {
                // Set today's date as default for sleep form
                const today = new Date();
                document.getElementById('sleep-date').value = today.toISOString().split('T')[0];
                document.getElementById('bedtime').value = '22:30';
                document.getElementById('wake-time').value = '06:30';

                // Update UI components
                this.updateUI();
            }

            // Handle sleep form submission
            handleSleepFormSubmit() {
                const date = document.getElementById('sleep-date').value;
                const quality = parseInt(document.getElementById('sleep-quality').value);
                const bedtime = document.getElementById('bedtime').value;
                const wakeTime = document.getElementById('wake-time').value;
                const notes = document.getElementById('sleep-notes').value;
                
                // Calculate sleep duration
                const bedtimeParts = bedtime.split(':').map(Number);
                const wakeParts = wakeTime.split(':').map(Number);
                
                let bedtimeHours = bedtimeParts[0] + bedtimeParts[1] / 60;
                let wakeHours = wakeParts[0] + wakeParts[1] / 60;
                
                // Adjust if sleep crosses midnight
                if (wakeHours < bedtimeHours) {
                    wakeHours += 24;
                }
                
                const duration = parseFloat((wakeHours - bedtimeHours).toFixed(2));
                
                // Create sleep entry
                const entry = {
                    date,
                    quality,
                    bedtime,
                    wakeTime,
                    duration,
                    notes,
                    factors: {
                        screenTime: document.getElementById('screen-time').checked,
                        caffeine: document.getElementById('caffeine').checked,
                        exercise: document.getElementById('exercise').checked
                    }
                };
                
                this.addSleepEntry(entry);
                this.showToast('Sleep log saved successfully', 'success');
                
                // Reset form
                document.getElementById('sleep-notes').value = '';
                document.getElementById('screen-time').checked = false;
                document.getElementById('caffeine').checked = false;
                document.getElementById('exercise').checked = false;
            }

            // Update sleep logs table
            updateSleepLogs() {
                const tableBody = document.getElementById('sleep-log-table');
                tableBody.innerHTML = '';
                
                // Get the 10 most recent entries
                const recentEntries = this.sleepData.slice(0, 10);
                
                if (recentEntries.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                            No sleep data available
                        </td>
                    `;
                    tableBody.appendChild(row);
                    return;
                }
                
                recentEntries.forEach(entry => {
                    const row = document.createElement('tr');
                    row.className = 'sleep-entry-item';
                    
                    // Format date
                    const dateObj = new Date(entry.date);
                    const formattedDate = dateObj.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
                    
                    // Create star rating
                    let starsHtml = '';
                    for (let i = 1; i <= 5; i++) {
                        if (i <= entry.quality) {
                            starsHtml += '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-400 inline" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>';
                        } else {
                            starsHtml += '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-300 dark:text-gray-600 inline" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>';
                        }
                    }
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 dark:text-gray-100">${formattedDate}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900 dark:text-gray-100">${entry.duration.toFixed(1)}h</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 dark:text-gray-100">${this.formatTime(entry.bedtime)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 dark:text-gray-100">${this.formatTime(entry.wakeTime)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 dark:text-gray-100">${starsHtml}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="edit-entry text-primary dark:text-primary-light hover:text-primary-dark dark:hover:text-primary-light mr-3" data-date="${entry.date}">
                                Edit
                            </button>
                            <button class="delete-entry text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" data-date="${entry.date}">
                                Delete
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to edit/delete buttons
                document.querySelectorAll('.edit-entry').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.editSleepEntry(btn.getAttribute('data-date'));
                    });
                });
                
                document.querySelectorAll('.delete-entry').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const date = btn.getAttribute('data-date');
                        this.showConfirmModal(
                            'Delete Sleep Entry', 
                            'Are you sure you want to delete this sleep entry?',
                            () => this.deleteSleepEntry(date)
                        );
                    });
                });
            }

            // Update GitHub-style contribution grid
            updateContributionGrid() {
                const gridContainer = document.getElementById('contribution-grid');
                gridContainer.innerHTML = '';
                
                // Get dates for the last 12 weeks
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 84); // 12 weeks * 7 days
                
                // Create day labels (Sun, Mon, etc.)
                const dayLabelsRow = document.createElement('div');
                dayLabelsRow.className = 'flex mb-1';
                
                // Empty first cell for alignment
                const emptyCell = document.createElement('div');
                emptyCell.className = 'w-8 text-xs text-gray-500 dark:text-gray-400 text-center';
                dayLabelsRow.appendChild(emptyCell);
                
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach((day, index) => {
                    if (index === 0 || index === 3 || index === 6) {
                        const dayLabel = document.createElement('div');
                        dayLabel.className = 'w-[18px] text-xs text-gray-500 dark:text-gray-400 text-center';
                        dayLabel.textContent = day.charAt(0); // Just the first letter
                        dayLabelsRow.appendChild(dayLabel);
                    } else {
                        // Empty placeholder
                        const dayLabel = document.createElement('div');
                        dayLabel.className = 'w-[18px]';
                        dayLabelsRow.appendChild(dayLabel);
                    }
                });
                
                gridContainer.appendChild(dayLabelsRow);
                
                // Organize by week
                const weeks = [];
                let currentDate = new Date(startDate);
                
                while (currentDate <= endDate) {
                    const weekStart = new Date(currentDate);
                    weekStart.setDate(currentDate.getDate() - currentDate.getDay()); // Start of the week (Sunday)
                    
                    const week = {
                        start: new Date(weekStart),
                        days: []
                    };
                    
                    for (let i = 0; i < 7; i++) {
                        const day = new Date(weekStart);
                        day.setDate(weekStart.getDate() + i);
                        
                        if (day >= startDate && day <= endDate) {
                            const dayStr = day.toISOString().split('T')[0];
                            const sleepEntry = this.sleepData.find(entry => entry.date === dayStr);
                            
                            week.days.push({
                                date: dayStr,
                                hasData: !!sleepEntry,
                                duration: sleepEntry ? sleepEntry.duration : 0,
                                quality: sleepEntry ? sleepEntry.quality : 0
                            });
                        } else {
                            week.days.push({
                                date: null,
                                hasData: false,
                                duration: 0,
                                quality: 0
                            });
                        }
                    }
                    
                    weeks.push(week);
                    
                    // Move to the next week
                    currentDate.setDate(currentDate.getDate() + 7);
                }
                
                // Create the grid
                const grid = document.createElement('div');
                grid.className = 'flex';
                
                // Add month labels at the top
                const months = [];
                let lastMonth = -1;
                
                // Calculate month positions
                for (let i = 0; i < weeks.length; i++) {
                    const month = new Date(weeks[i].start).getMonth();
                    if (month !== lastMonth) {
                        months.push({
                            name: new Date(weeks[i].start).toLocaleDateString(undefined, { month: 'short' }),
                            position: i
                        });
                        lastMonth = month;
                    }
                }
                
                // Create month labels row
                const monthLabelsContainer = document.createElement('div');
                monthLabelsContainer.className = 'flex mb-1 ml-8';
                
                months.forEach((month, index) => {
                    const monthLabel = document.createElement('div');
                    monthLabel.className = 'text-xs text-gray-500 dark:text-gray-400';
                    monthLabel.textContent = month.name;
                    monthLabel.style.position = 'absolute';
                    monthLabel.style.left = `${month.position * 18 + 32}px`; // Position based on week
                    monthLabelsContainer.appendChild(monthLabel);
                });
                
                gridContainer.insertBefore(monthLabelsContainer, dayLabelsRow);
                
                // Create each week row
                weeks.forEach(week => {
                    const weekRow = document.createElement('div');
                    weekRow.className = 'flex items-center';
                    
                    // Add week number label
                    const weekLabel = document.createElement('div');
                    weekLabel.className = 'text-xs text-gray-500 dark:text-gray-400 w-8 text-center';
                    
                    // Only show week label for some weeks to avoid crowding
                    if (weeks.indexOf(week) % 2 === 0) {
                        const weekNumber = this.getWeekNumber(week.start);
                        weekLabel.textContent = `W${weekNumber}`;
                    }
                    
                    weekRow.appendChild(weekLabel);
                    
                    // Add days in the week
                    week.days.forEach(day => {
                        const dayCell = document.createElement('div');
                        dayCell.className = 'contribution-cell tooltip';
                        
                        if (day.date) {
                            if (day.hasData) {
                                if (day.duration < 6) {
                                    dayCell.classList.add('bg-sleep-poor');
                                } else if (day.duration < 7) {
                                    dayCell.classList.add('bg-sleep-fair');
                                } else if (day.duration < 8) {
                                    dayCell.classList.add('bg-sleep-good');
                                } else {
                                    dayCell.classList.add('bg-sleep-excellent');
                                }
                                
                                // Add tooltip
                                const tooltipText = document.createElement('span');
                                tooltipText.className = 'tooltip-text';
                                
                                const formattedDate = new Date(day.date).toLocaleDateString(undefined, {
                                    weekday: 'short',
                                    month: 'short',
                                    day: 'numeric'
                                });
                                
                                tooltipText.innerHTML = `
                                    ${formattedDate}<br>
                                    ${day.duration.toFixed(1)} hours<br>
                                    Quality: ${day.quality}/5
                                `;
                                
                                dayCell.appendChild(tooltipText);
                            } else {
                                dayCell.classList.add('bg-gray-200', 'dark:bg-gray-700');
                                
                                // Add tooltip for days without data
                                const tooltipText = document.createElement('span');
                                tooltipText.className = 'tooltip-text';
                                
                                const formattedDate = new Date(day.date).toLocaleDateString(undefined, {
                                    weekday: 'short',
                                    month: 'short',
                                    day: 'numeric'
                                });
                                
                                tooltipText.textContent = `${formattedDate}\nNo data`;
                                dayCell.appendChild(tooltipText);
                            }
                        } else {
                            dayCell.classList.add('bg-transparent');
                        }
                        
                        weekRow.appendChild(dayCell);
                    });
                    
                    grid.appendChild(weekRow);
                });
                
                gridContainer.appendChild(grid);
            }

            // Update sleep trend chart
            updateSleepTrendChart() {
                const ctx = document.getElementById('sleep-trend-chart').getContext('2d');
                
                // Get last 14 days of data
                const last14Days = [];
                for (let i = 13; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateString = date.toISOString().split('T')[0];
                    
                    const entry = this.sleepData.find(item => item.date === dateString);
                    last14Days.push({
                        date: dateString,
                        formatted: new Date(dateString).toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' }),
                        duration: entry ? entry.duration : null,
                        quality: entry ? entry.quality : null
                    });
                }
                
                // Destroy existing chart if it exists
                if (this.sleepTrendChart) {
                    this.sleepTrendChart.destroy();
                }
                
                // Create new chart
                this.sleepTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last14Days.map(day => day.formatted),
                        datasets: [
                            {
                                label: 'Sleep Duration (hours)',
                                data: last14Days.map(day => day.duration),
                                backgroundColor: '#5D5CDE33',
                                borderColor: '#5D5CDE',
                                borderWidth: 2,
                                fill: 'start',
                                tension: 0.4,
                                pointBackgroundColor: '#5D5CDE',
                                pointBorderColor: '#FFF',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Sleep Quality (1-5)',
                                data: last14Days.map(day => day.quality),
                                backgroundColor: '#F7CB4D33',
                                borderColor: '#F7CB4D',
                                borderWidth: 2,
                                tension: 0.4,
                                pointBackgroundColor: '#F7CB4D',
                                pointBorderColor: '#FFF',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                min: 0,
                                max: 12,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Hours',
                                    color: '#5D5CDE'
                                },
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text'),
                                    callback: function(value) {
                                        return value + 'h';
                                    }
                                },
                                grid: {
                                    color: 'rgba(200, 200, 200, 0.2)'
                                }
                            },
                            y1: {
                                min: 0,
                                max: 5,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Quality',
                                    color: '#F7CB4D'
                                },
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text'),
                                    stepSize: 1
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    boxWidth: 6,
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                titleColor: '#FFF',
                                bodyColor: '#FFF',
                                caretSize: 5,
                                cornerRadius: 4,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            return `Duration: ${context.raw !== null ? context.raw.toFixed(1) + 'h' : 'No data'}`;
                                        } else {
                                            return `Quality: ${context.raw !== null ? context.raw + '/5' : 'No data'}`;
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Setup theme toggle event to update chart colors
                document.getElementById('theme-toggle').addEventListener('click', () => {
                    this.updateChartTheme();
                });
                
                // Update chart theme based on current mode
                this.updateChartTheme();
            }

            // Update analytics charts
            updateAnalyticsCharts() {
                this.updateDurationDistributionChart();
                this.updateQualityDurationChart();
                this.updateBedtimeConsistencyChart();
                this.updateQualityTrendChart();
            }

            // Update duration distribution chart
            updateDurationDistributionChart() {
                const ctx = document.getElementById('duration-distribution-chart').getContext('2d');
                
                // Calculate distribution
                const durations = [
                    { range: '<6h', count: 0, color: '#e67c73' },
                    { range: '6-7h', count: 0, color: '#f7cb4d' },
                    { range: '7-8h', count: 0, color: '#80c883' },
                    { range: '>8h', count: 0, color: '#4285f4' }
                ];
                
                this.sleepData.forEach(entry => {
                    if (entry.duration < 6) {
                        durations[0].count++;
                    } else if (entry.duration < 7) {
                        durations[1].count++;
                    } else if (entry.duration < 8) {
                        durations[2].count++;
                    } else {
                        durations[3].count++;
                    }
                });
                
                // Destroy existing chart if it exists
                if (this.durationDistributionChart) {
                    this.durationDistributionChart.destroy();
                }
                
                // Create new chart
                this.durationDistributionChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: durations.map(d => d.range),
                        datasets: [{
                            data: durations.map(d => d.count),
                            backgroundColor: durations.map(d => d.color),
                            borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text'),
                                    padding: 15,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} nights (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Update quality vs duration chart
            updateQualityDurationChart() {
                const ctx = document.getElementById('quality-duration-chart').getContext('2d');
                
                // Prepare data
                const data = this.sleepData.map(entry => ({
                    x: entry.duration,
                    y: entry.quality,
                    date: new Date(entry.date).toLocaleDateString(undefined, {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    })
                }));
                
                // Destroy existing chart if it exists
                if (this.qualityDurationChart) {
                    this.qualityDurationChart.destroy();
                }
                
                // Create new chart
                this.qualityDurationChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Sleep Quality vs Duration',
                            data: data,
                            backgroundColor: '#5D5CDE',
                            pointRadius: 8,
                            pointHoverRadius: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Sleep Duration (hours)',
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                                },
                                min: 4,
                                max: 10,
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text'),
                                    callback: function(value) {
                                        return value + 'h';
                                    }
                                },
                                grid: {
                                    color: 'rgba(200, 200, 200, 0.2)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Sleep Quality (1-5)',
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                                },
                                min: 0,
                                max: 5,
                                ticks: {
                                    stepSize: 1,
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                                },
                                grid: {
                                    color: 'rgba(200, 200, 200, 0.2)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return [
                                            context.raw.date,
                                            `Duration: ${context.raw.x.toFixed(1)}h`,
                                            `Quality: ${context.raw.y}/5`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Update bedtime consistency chart
            updateBedtimeConsistencyChart() {
                const ctx = document.getElementById('bedtime-consistency-chart').getContext('2d');
                
                // Get last 14 days of data
                const last14Days = [];
                for (let i = 13; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateString = date.toISOString().split('T')[0];
                    
                    const entry = this.sleepData.find(item => item.date === dateString);
                    if (entry) {
                        // Convert bedtime to minutes
                        const [hours, minutes] = entry.bedtime.split(':').map(Number);
                        // Use hours since midnight (e.g., 23:30 -> 23.5)
                        let bedtimeValue = hours + minutes / 60;
                        
                        // Adjust for time after midnight
                        if (bedtimeValue < 6) {
                            bedtimeValue += 24;
                        }
                        
                        last14Days.push({
                            date: dateString,
                            formatted: new Date(dateString).toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' }),
                            bedtime: bedtimeValue
                        });
                    }
                }
                
                // Destroy existing chart if it exists
                if (this.bedtimeConsistencyChart) {
                    this.bedtimeConsistencyChart.destroy();
                }
                
                // Create new chart
                this.bedtimeConsistencyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last14Days.map(day => day.formatted),
                        datasets: [{
                            label: 'Bedtime',
                            data: last14Days.map(day => day.bedtime),
                            backgroundColor: 'rgba(128, 200, 131, 0.2)',
                            borderColor: 'rgba(128, 200, 131, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: 'start',
                            pointBackgroundColor: 'rgba(128, 200, 131, 1)',
                            pointBorderColor: '#FFF',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Bedtime',
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                                },
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text'),
                                    callback: function(value) {
                                        // Convert decimal hours to time format
                                        const adjustedValue = value >= 24 ? value - 24 : value;
                                        const hours = Math.floor(adjustedValue);
                                        const minutes = Math.round((adjustedValue - hours) * 60);
                                        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                                    }
                                },
                                min: 20, // 8 PM
                                max: 28, // 4 AM
                                reverse: true, // Earlier times at the top
                                grid: {
                                    color: 'rgba(200, 200, 200, 0.2)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        // Convert decimal hours to time format
                                        const adjustedValue = value >= 24 ? value - 24 : value;
                                        const hours = Math.floor(adjustedValue);
                                        const minutes = Math.round((adjustedValue - hours) * 60);
                                        return `Bedtime: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Update quality trend chart
            updateQualityTrendChart() {
                const ctx = document.getElementById('quality-trend-chart').getContext('2d');
                
                // Group data by week
                const weeklyData = {};
                
                this.sleepData.forEach(entry => {
                    const date = new Date(entry.date);
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay()); // Set to Sunday
                    const weekKey = weekStart.toISOString().split('T')[0];
                    
                    if (!weeklyData[weekKey]) {
                        weeklyData[weekKey] = {
                            quality: [],
                            weekNumber: this.getWeekNumber(weekStart)
                        };
                    }
                    
                    weeklyData[weekKey].quality.push(entry.quality);
                });
                
                // Calculate average quality for each week
                const weeklyAverages = Object.keys(weeklyData)
                    .sort() // Sort by date
                    .map(week => {
                        const avg = weeklyData[week].quality.reduce((sum, val) => sum + val, 0) / weeklyData[week].quality.length;
                        return {
                            week: week,
                            weekLabel: `Week ${weeklyData[week].weekNumber}`,
                            avgQuality: parseFloat(avg.toFixed(1))
                        };
                    });
                
                // Take only the last 8 weeks
                const recentWeeks = weeklyAverages.slice(-8);
                
                // Destroy existing chart if it exists
                if (this.qualityTrendChart) {
                    this.qualityTrendChart.destroy();
                }
                
                // Create new chart
                this.qualityTrendChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: recentWeeks.map(w => w.weekLabel),
                        datasets: [{
                            label: 'Average Sleep Quality',
                            data: recentWeeks.map(w => w.avgQuality),
                            backgroundColor: recentWeeks.map(w => {
                                // Color bars based on quality
                                if (w.avgQuality < 2.5) return '#e67c73';
                                if (w.avgQuality < 3.5) return '#f7cb4d';
                                if (w.avgQuality < 4.5) return '#80c883';
                                return '#4285f4';
                            }),
                            borderWidth: 0,
                            borderRadius: 4,
                            barPercentage: 0.6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Average Quality (1-5)',
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                                },
                                min: 0,
                                max: 5,
                                ticks: {
                                    stepSize: 1,
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                                },
                                grid: {
                                    color: 'rgba(200, 200, 200, 0.2)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Avg Quality: ${context.raw}/5`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Update summary statistics
            updateSummaryStats() {
                // Calculate sleep score
                let sleepScore = 0;
                
                if (this.sleepData.length > 0) {
                    const recentData = this.sleepData.slice(0, 14); // Last 14 days
                    
                    // Duration score (40%)
                    const durationScore = recentData.reduce((sum, entry) => {
                        let score = 0;
                        if (entry.duration >= 7 && entry.duration <= 9) {
                            score = 100; // Optimal range
                        } else if (entry.duration >= 6 && entry.duration < 7) {
                            score = 75; // Good
                        } else if (entry.duration > 9) {
                            score = 75; // Too much
                        } else if (entry.duration >= 5 && entry.duration < 6) {
                            score = 50; // Poor
                        } else {
                            score = 25; // Very poor
                        }
                        return sum + score;
                    }, 0) / recentData.length * 0.4;
                    
                    // Quality score (30%)
                    const qualityScore = recentData.reduce((sum, entry) => {
                        return sum + (entry.quality / 5 * 100);
                    }, 0) / recentData.length * 0.3;
                    
                    // Consistency score (30%)
                    const bedtimes = recentData.map(entry => {
                        const [hours, minutes] = entry.bedtime.split(':').map(Number);
                        let bedtimeValue = hours * 60 + minutes;
                        if (bedtimeValue < 360) { // If before 6am, assume it's after midnight
                            bedtimeValue += 1440; // Add 24 hours
                        }
                        return bedtimeValue;
                    });
                    
                    // Calculate standard deviation of bedtimes
                    const avgBedtime = bedtimes.reduce((sum, time) => sum + time, 0) / bedtimes.length;
                    const bedtimeVariance = bedtimes.reduce((sum, time) => sum + Math.pow(time - avgBedtime, 2), 0) / bedtimes.length;
                    const bedtimeStdDev = Math.sqrt(bedtimeVariance);
                    
                    // Convert to consistency score
                    let consistencyScore = 0;
                    if (bedtimeStdDev <= 15) { // Within 15 minutes
                        consistencyScore = 100;
                    } else if (bedtimeStdDev <= 30) { // Within 30 minutes
                        consistencyScore = 85;
                    } else if (bedtimeStdDev <= 45) { // Within 45 minutes
                        consistencyScore = 70;
                    } else if (bedtimeStdDev <= 60) { // Within 1 hour
                        consistencyScore = 55;
                    } else {
                        consistencyScore = 40;
                    }
                    
                    const finalConsistencyScore = consistencyScore * 0.3;
                    
                    // Calculate total sleep score
                    sleepScore = Math.round(durationScore + qualityScore + finalConsistencyScore);
                    
                    // Update bedtime variance
                    document.getElementById('bedtime-variance').textContent = `±${Math.round(bedtimeStdDev)} min`;
                    
                    // Set consistency rating
                    let consistencyRating = 'Poor';
                    if (bedtimeStdDev <= 15) consistencyRating = 'Excellent';
                    else if (bedtimeStdDev <= 30) consistencyRating = 'Good';
                    else if (bedtimeStdDev <= 60) consistencyRating = 'Fair';
                    
                    document.getElementById('consistency-score').textContent = consistencyRating;
                    
                    // Calculate average duration
                    const avgDuration = recentData.reduce((sum, entry) => sum + entry.duration, 0) / recentData.length;
                    document.getElementById('avg-duration').textContent = `${avgDuration.toFixed(1)}h`;
                    
                    // Calculate duration trend (compared to previous week)
                    const thisWeek = recentData.slice(0, 7);
                    const prevWeek = recentData.slice(7, 14);
                    
                    if (prevWeek.length > 0) {
                        const thisWeekAvg = thisWeek.reduce((sum, entry) => sum + entry.duration, 0) / thisWeek.length;
                        const prevWeekAvg = prevWeek.reduce((sum, entry) => sum + entry.duration, 0) / prevWeek.length;
                        const trend = thisWeekAvg - prevWeekAvg;
                        
                        const trendElement = document.getElementById('duration-trend');
                        if (trend > 0) {
                            trendElement.textContent = `↑ ${Math.abs(trend).toFixed(1)}h`;
                            trendElement.className = 'text-green-500';
                        } else if (trend < 0) {
                            trendElement.textContent = `↓ ${Math.abs(trend).toFixed(1)}h`;
                            trendElement.className = 'text-red-500';
                        } else {
                            trendElement.textContent = `= 0.0h`;
                            trendElement.className = 'text-gray-500 dark:text-gray-400';
                        }
                    }
                    
                    // Calculate average quality
                    const avgQuality = recentData.reduce((sum, entry) => sum + entry.quality, 0) / recentData.length;
                    document.getElementById('quality-score').textContent = `${avgQuality.toFixed(1)} / 5`;
                }
                
                // Update sleep score display
                document.getElementById('sleep-score').textContent = sleepScore;
                document.getElementById('sleep-score-bar').style.width = `${sleepScore}%`;
                
                // Update color based on score
                const scoreBar = document.getElementById('sleep-score-bar');
                if (sleepScore < 50) {
                    scoreBar.className = 'bg-sleep-poor h-2.5 rounded-full';
                } else if (sleepScore < 70) {
                    scoreBar.className = 'bg-sleep-fair h-2.5 rounded-full';
                } else if (sleepScore < 85) {
                    scoreBar.className = 'bg-sleep-good h-2.5 rounded-full';
                } else {
                    scoreBar.className = 'bg-sleep-excellent h-2.5 rounded-full';
                }
                
                // Update data usage display
                this.updateDataUsage();
            }

            // Edit sleep entry
            editSleepEntry(date) {
                const entry = this.sleepData.find(item => item.date === date);
                if (entry) {
                    document.getElementById('sleep-date').value = entry.date;
                    document.getElementById('sleep-quality').value = entry.quality;
                    document.getElementById('bedtime').value = entry.bedtime;
                    document.getElementById('wake-time').value = entry.wakeTime;
                    document.getElementById('sleep-notes').value = entry.notes || '';
                    
                    // Update rating buttons
                    document.querySelectorAll('.sleep-rating-btn').forEach(btn => {
                        btn.classList.remove('bg-primary', 'text-white', 'dark:bg-primary-light');
                        btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
                        
                        if (parseInt(btn.getAttribute('data-rating')) === entry.quality) {
                            btn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                            btn.classList.add('bg-primary', 'text-white', 'dark:bg-primary-light');
                        }
                    });
                    
                    // Set checkboxes
                    document.getElementById('screen-time').checked = entry.factors?.screenTime || false;
                    document.getElementById('caffeine').checked = entry.factors?.caffeine || false;
                    document.getElementById('exercise').checked = entry.factors?.exercise || false;
                    
                    // Navigate to log section
                    document.querySelectorAll('.nav-link').forEach(link => {
                        if (link.getAttribute('data-section') === 'log') {
                            link.click();
                        }
                    });
                }
            }

            // Export data
            exportData() {
                const exportArea = document.getElementById('export-area');
                const exportJson = document.getElementById('export-json');
                
                exportArea.classList.remove('hidden');
                exportJson.value = JSON.stringify(this.sleepData, null, 2);
                exportJson.select();
                
                this.showToast('Data ready for export. Copy the text and save it to a file.', 'info');
            }

            // Import data
            importData() {
                const importJson = document.getElementById('import-json');
                const importStatus = document.getElementById('import-status');
                
                try {
                    const data = JSON.parse(importJson.value);
                    
                    if (Array.isArray(data)) {
                        this.showConfirmModal(
                            'Import Data', 
                            'This will replace your current data with the imported data. Continue?',
                            () => {
                                this.sleepData = data;
                                this.saveData();
                                this.updateUI();
                                
                                importJson.value = '';
                                importStatus.innerHTML = 'Data imported successfully!';
                                importStatus.className = 'mt-2 text-sm text-green-500 dark:text-green-400';
                                importStatus.classList.remove('hidden');
                                
                                setTimeout(() => {
                                    importStatus.classList.add('hidden');
                                }, 3000);
                                
                                this.showToast('Data imported successfully', 'success');
                            }
                        );
                    } else {
                        throw new Error('Invalid data format. Expected an array.');
                    }
                } catch (error) {
                    importStatus.innerHTML = `Error: ${error.message}`;
                    importStatus.className = 'mt-2 text-sm text-red-500 dark:text-red-400';
                    importStatus.classList.remove('hidden');
                    
                    setTimeout(() => {
                        importStatus.classList.add('hidden');
                    }, 5000);
                }
            }

            // Load demo data
            loadDemoData() {
                const today = new Date();
                const demoData = [];
                
                // Generate data for the last 60 days
                for (let i = 60; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    
                    // Skip some days to simulate missing data
                    if (i % 13 === 0 || i % 27 === 0) {
                        continue;
                    }
                    
                    const dateString = date.toISOString().split('T')[0];
                    const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
                    
                    // Simulate different sleep patterns on weekdays vs weekends
                    let bedHour, bedMinute, wakeHour, wakeMinute, quality;
                    
                    if (dayOfWeek === 5 || dayOfWeek === 6) { // Weekend (Friday, Saturday)
                        // Later bedtime on weekends
                        bedHour = 23 + Math.floor(Math.random() * 2); // 11pm - 12am
                        if (bedHour >= 24) bedHour -= 24; // Convert to 0-23 format
                        bedMinute = Math.floor(Math.random() * 60);
                        
                        // Later wake time on weekends
                        wakeHour = 8 + Math.floor(Math.random() * 2); // 8am - 9am
                        wakeMinute = Math.floor(Math.random() * 60);
                        
                        // Slightly worse quality on weekends (party effects)
                        quality = 2 + Math.floor(Math.random() * 3); // 2-4
                    } else {
                        // Regular bedtime on weekdays
                        bedHour = 22 + Math.floor(Math.random() * 2); // 10pm - 11pm
                        bedMinute = Math.floor(Math.random() * 60);
                        
                        // Regular wake time on weekdays
                        wakeHour = 6 + Math.floor(Math.random() * 2); // 6am - 7am
                        wakeMinute = Math.floor(Math.random() * 60);
                        
                        // Better quality on weekdays (routine)
                        quality = 3 + Math.floor(Math.random() * 3); // 3-5
                    }
                    
                    // Format times
                    const bedtime = `${bedHour.toString().padStart(2, '0')}:${bedMinute.toString().padStart(2, '0')}`;
                    const wakeTime = `${wakeHour.toString().padStart(2, '0')}:${wakeMinute.toString().padStart(2, '0')}`;
                    
                    // Calculate duration (handle time crossing midnight)
                    let bedtimeHours = bedHour + bedMinute / 60;
                    let wakeHours = wakeHour + wakeMinute / 60;
                    
                    if (wakeHours < bedtimeHours) {
                        wakeHours += 24;
                    }
                    
                    const duration = parseFloat((wakeHours - bedtimeHours).toFixed(2));
                    
                    // Add some variety in factors
                    const screenTime = Math.random() < 0.7; // 70% chance of using screens
                    const caffeine = Math.random() < 0.4; // 40% chance of caffeine
                    const exercise = Math.random() < 0.5; // 50% chance of exercise
                    
                    demoData.push({
                        date: dateString,
                        quality,
                        bedtime,
                        wakeTime,
                        duration,
                        notes: "",
                        factors: {
                            screenTime,
                            caffeine,
                            exercise
                        }
                    });
                }
                
                // Add some notes to random entries
                const notes = [
                    "Felt very tired today.",
                    "Woke up feeling refreshed.",
                    "Had trouble falling asleep.",
                    "Woke up several times during the night.",
                    "Had a nightmare and couldn't go back to sleep.",
                    "Best sleep in a long time!",
                    "Too much caffeine during the day."
                ];
                
                for (let i = 0; i < 15; i++) {
                    const randomIndex = Math.floor(Math.random() * demoData.length);
                    const randomNote = notes[Math.floor(Math.random() * notes.length)];
                    if (demoData[randomIndex]) {
                        demoData[randomIndex].notes = randomNote;
                    }
                }
                
                // Sort by date (newest first)
                demoData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                this.sleepData = demoData;
            }

            // Show toast message
            showToast(message, type = 'info') {
                // Check if toast container exists, if not create it
                let toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.className = 'fixed bottom-4 right-4 z-50 flex flex-col space-y-2';
                    document.body.appendChild(toastContainer);
                }
                
                // Create toast element
                const toast = document.createElement('div');
                toast.className = 'px-4 py-2 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-y-2 opacity-0';
                
                // Set color based on type
                switch (type) {
                    case 'success':
                        toast.classList.add('bg-green-500');
                        break;
                    case 'error':
                        toast.classList.add('bg-red-500');
                        break;
                    case 'warning':
                        toast.classList.add('bg-yellow-500');
                        break;
                    default:
                        toast.classList.add('bg-blue-500');
                }
                
                toast.textContent = message;
                
                // Add to container
                toastContainer.appendChild(toast);
                
                // Animate in
                setTimeout(() => {
                    toast.classList.remove('translate-y-2', 'opacity-0');
                }, 10);
                
                // Animate out after 3 seconds
                setTimeout(() => {
                    toast.classList.add('translate-y-2', 'opacity-0');
                    
                    // Remove from DOM after animation
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 3000);
            }

            // Show confirmation modal
            showConfirmModal(title, message, confirmCallback) {
                const modal = document.getElementById('modal');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const confirmButton = document.getElementById('modal-confirm');
                
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                
                // Remove previous confirm button handler
                const newConfirmBtn = confirmButton.cloneNode(true);
                confirmButton.parentNode.replaceChild(newConfirmBtn, confirmButton);
                
                // Add new confirm handler
                newConfirmBtn.addEventListener('click', () => {
                    confirmCallback();
                    modal.classList.add('hidden');
                });
                
                // Show modal
                modal.classList.remove('hidden');
            }

            // Update chart theme based on current mode
            updateChartTheme() {
                const isDarkMode = document.documentElement.classList.contains('dark');
                const textColor = isDarkMode ? '#E5E7EB' : '#1F2937';
                
                const updateChartColors = (chart) => {
                    if (!chart) return;
                    
                    // Update text colors
                    if (chart.options.scales?.x) {
                        chart.options.scales.x.ticks.color = textColor;
                        if (chart.options.scales.x.title) {
                            chart.options.scales.x.title.color = textColor;
                        }
                    }
                    
                    if (chart.options.scales?.y) {
                        chart.options.scales.y.ticks.color = textColor;
                        if (chart.options.scales.y.title) {
                            chart.options.scales.y.title.color = textColor;
                        }
                    }
                    
                    if (chart.options.scales?.y1) {
                        chart.options.scales.y1.ticks.color = textColor;
                        if (chart.options.scales.y1.title) {
                            chart.options.scales.y1.title.color = textColor;
                        }
                    }
                    
                    // Update legend colors
                    if (chart.options.plugins?.legend?.labels) {
                        chart.options.plugins.legend.labels.color = textColor;
                    }
                    
                    // Update doughnut chart border color
                    if (chart.config.type === 'doughnut' && chart.data.datasets.length > 0) {
                        chart.data.datasets[0].borderColor = isDarkMode ? '#1f2937' : '#ffffff';
                    }
                    
                    // Update the chart
                    chart.update();
                };
                
                // Update all charts
                updateChartColors(this.sleepTrendChart);
                updateChartColors(this.durationDistributionChart);
                updateChartColors(this.qualityDurationChart);
                updateChartColors(this.bedtimeConsistencyChart);
                updateChartColors(this.qualityTrendChart);
            }

            // Helper function to format time
            formatTime(timeStr) {
                const [hours, minutes] = timeStr.split(':');
                const hour = parseInt(hours);
                const period = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                return `${hour12}:${minutes} ${period}`;
            }

            // Helper function to get week number
            getWeekNumber(date) {
                const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            }

            // Update data usage display
            updateDataUsage() {
                const dataSize = JSON.stringify(this.sleepData).length;
                const dataSizeKB = (dataSize / 1024).toFixed(2);
                document.getElementById('data-usage').textContent = `${dataSizeKB} KB`;
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const sleepTracker = new SleepTracker();
        });
    </script>
</body>
</html>
